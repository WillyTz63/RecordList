name: Continuous Integration

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SALESFORCE_USERNAME: ${{ secrets.PLAYGROUND_USERNAME }}
      SALESFORCE_PASSWORD: ${{ secrets.PLAYGROUND_PASSWORD }}
      SALESFORCE_INSTANCE_URL: "https://wise-impala-axjif7-dev-ed.trailblaze.my.salesforce.com/"

    steps:
    - name: Checkout the code
      uses: actions/checkout@v2

    - name: Server key PRE
      run: echo "$GITHUB_CONTEXT"

    - name: Install Salesforce CLI
      run: |
        npm install sfdx-cli
        node_modules/sfdx-cli/bin/run --version
        node_modules/sfdx-cli/bin/run plugins --core

    - name: Server key
      run: echo "ASDA" > server1.key

    - name: Authenticate to Salesforce
      env:
        SFDX_JWT_KEY: ${{ secrets.SFDC_KEY }}
      run: echo "${SFDX_JWT_KEY}" > server.key
          node_modules/sfdx-cli/bin/run force:auth:jwt:grant --clientid ${{ secrets.CONSUMER_KEY }} --jwtkeyfile server.key --username $SALESFORCE_USERNAME --setdefaultdevhubusername --setalias devhub
          node_modules/sfdx-cli/bin/run force:org:display --json -u $SALESFORCE_USERNAME > sfdx-auth.json

    - name: Install dependencies
      run: node_modules/sfdx-cli/bin/run force:source:install -r -x ./manifest/package.xml


    - name: Deploy to Salesforce
      if: github.event_name == 'push'
      run: node_modules/sfdx-cli/bin/run force:source:deploy -x ./manifest/package.xml -l RunLocalTests -u devhub -c