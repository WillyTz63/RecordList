name: Continuous Integration

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SALESFORCE_USERNAME: ${{ secrets.PLAYGROUND_USERNAME }}
      SALESFORCE_PASSWORD: ${{ secrets.PLAYGROUND_PASSWORD }}
      SALESFORCE_INSTANCE_URL: "https://wise-impala-axjif7-dev-ed.trailblaze.my.salesforce.com/"

    steps:
    - name: Checkout the code
      uses: actions/checkout@v2

    - name: Install Salesforce CLI
      run: |
        npm install sfdx-cli
        node_modules/sfdx-cli/bin/run --version
        node_modules/sfdx-cli/bin/run plugins --core

    - name: Authenticate to Salesforce
      run: echo "${{ secrets.SALESFORCE_JWT_SECRET_KEY }}" > server.key
      node_modules/sfdx-cli/bin/run force:auth:jwt:grant --clientid ${{ secrets.CONSUMER_KEY }} --jwtkeyfile ${{ secrets.SFDC_KEY }} --username $SALESFORCE_USERNAME --setdefaultdevhubusername -a devhub

    - name: Install dependencies
      run: sfdx force:source:install -r -x ./manifest/package.xml

    - name: Run tests
      run: sfdx force:apex:test:run

    - name: Deploy to Salesforce
      if: github.event_name == 'push'
      run: sfdx force:source:deploy -p force-app
